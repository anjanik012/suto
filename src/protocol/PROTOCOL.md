# Version 1.3.2

This is the table of all message types and their functions. After the description there is the allowed order of messages that are
required.

|    Message Types    |                                                                                                            Function                                                                                                           |                                                                  More Info                                                                                                            |
|:-------------------:|:-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|
| `SUTO_%s@%h+`       |                                                                          A _UDP_ broadcast sent by __desktop to client__<br> to start authentication                                                                          | `%s` is the _username_ for which the auth is to be done. <br> `%h` is the hostname of the system. <br> The client is to open a TCP Connection on port _2021_<br>after receiving this. |
|  `SUTO_C_GET_SALTA` | Sent by the __client to desktop__ on TCP channel.<br>It is a request to desktop to send the password salt of the <br>_username_ specified in the `SUTO_%s@%h$` message, and<br>the random salt generated by the system.       |                              <br>It should only be sent if the client doesn't have the salt <br>for that user.                                                                        |
| `SUTO_SALTA_%s_%d`  | Sent by the __desktop to client__ on TCP Channel. It is a reply<br>for the message `SUTO_C_GET_SALTA`.<br>                                                                                                                    | `%s` is a placeholder for the password salt of the user. <br>`%d` is a placeholder for the random salt generated by the<br>system.                                                    |
|  `SUTO_C_GET_RSALT` |                                       Sent by __client to desktop__ on TCP Channel. It is a request<br>to desktop to generate a _random salt_ and send it<br>back to the Android client.                                      |                         It should only be sent if the Android client<br>does have the password salt of the<br>user.                                                                   |
| `SUTO_RSALT_%s`     | Sent by __desktop to client__ on TCP Channel. It is a reply <br>to the message `SUTO_C_GET_RSALT`.                                                                                                                            | `%s` is a placeholder for the random salt.                                                                                                                                            |
| `SUTO_CF_HASH_%s`   | Sent by __client to desktop__ on TCP Channel. It is a reply <br>after receiving both salts.                                                                                                                                   | `%s` is a placeholder for the final hash.                                                                                                                                             |
| `SUTO_AUTH_1`       | Sent by __desktop to client__ on TCP Channel.                                                                                                                                                                                 | It is sent if authentication succeeded.                                                                                                                                               |
| `SUTO_AUTH_0`       | Sent by __desktop to client__ on TCP Channel.                                                                                                                                                                                 | It is sent if authentication failed.                                                                                                                                                  |

## Order of message exchanges

### Establishing a reliable connection 

When the module is called by the system the authentication process begins. The module tries to establish a
connection with an authenticator on the network. Since, authenticator's IP address is not known the message
`SUTO_UDP_HELLO_%s` is broadcasted on _UDP_ protocol.

The client if listening on _UDP_ port _2020_ will the receive the message and will know the IP address of the system.
Now it will attempt to open a _TCP_ connection on port _2021_ to exchange further messages as we don't want to use _UDP_ 
to send further messages.

### Begin authentication process

Client has to check the _username_ it received on the hello message. If client doesn't has the password salt of the _username_
then it needs to get it by sending `SUTO_C_GET_SALTA` otherwise sends `SUTO_C_GET_RSALT` to just get a random salt.

System replies the message 
`SUTO_C_GET_SALTA` with `SUTO_SALTA_%s_%d`
`SUTO_C_GET_RSALT` with `SUTO_RSALT_%s`

Now the client has all the ingredients to calculate a hash. We use the `crypt()` function in `glibc` to calculate the hash as
it is used by the system itself to generate password hashes. The formula is:- 

`FINAL_HASH` = `crypt(crypt(PASSWORD_TEXT, SALT), RSALT)`

where,  
`PASSWORD_TEXT` is the plain text password for the _username_ which the client already had.

`SALT` is the salt used by the system to get a hash for the `PASSWORD_TEXT`

`RSALT` is the random salt generated by the module to rehash the hash for more security.

Now the client sends the `FINAL_HASH` with message `SUTO_CF_HASH_%s`. The system upon receiving it can recalculate the hash
and match it with received hash. If both the hashes are same then authentication is valid and sends back `SUTO_AUTH_1` otherwise
sends `SUTO_AUTH_0`.

### Why this formula?

`SALT` is not changing. It was generated and stored in system when the password was created by the user. So in theory, if the
password text is not known by some evadesdropper, it can store the `crypt(PASSWORD_TEXT, SALT)` and can use it later to 
authenticate the process. It wouldn't need to extract the password text from the hash. It would just need to send it sometime later
when the authentication is going on again. To prevent this, the hash must change with each authentication process.

Since, a different `RSALT` is generated each time `crypt(crypt(PASSWORD_TEXT, SALT), RSALT)` is also different each time. And to
an evadesdropper, it is not much of a value to store it because it won't be valid later ever. And also it is safe to say it is
impossible for it to recover password text from this hash.
